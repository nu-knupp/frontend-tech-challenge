worker_processes 1;

events { 
  worker_connections 1024; 
}

http {
  include       mime.types;
  default_type  application/octet-stream;
  sendfile        on;
  keepalive_timeout  65;

  upstream nextjs_api {
    server nextjs-app:3000;
  }

  upstream analytics_mfe {
    server analytics-mfe:8080;
  }

  server {
    listen 80;
    server_name _;

    # Proxy /api/* to Next.js API
    location /api/ {
      proxy_pass http://nextjs_api;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;
      
      # Cookie preservation
      proxy_cookie_path / /;
      proxy_cookie_domain ~^(.*)$ $1;

      # CORS headers - comentados para evitar duplicação com Next.js
      # add_header 'Access-Control-Allow-Origin' '$http_origin' always;
      # add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
      # add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization, Cookie' always;
      # add_header 'Access-Control-Allow-Credentials' 'true' always;

      # Handle preflight requests
      if ($request_method = OPTIONS) {
        add_header 'Access-Control-Allow-Origin' '$http_origin' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization, Cookie' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Max-Age' 1728000;
        add_header 'Content-Type' 'text/plain charset=UTF-8';
        add_header 'Content-Length' 0;
        return 204;
      }
    }

    # Proxy /analytics/* to Analytics MFE
    location /analytics/ {
      proxy_pass http://analytics_mfe;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Serve Next.js app for all other routes
    location / {
      proxy_pass http://nextjs_api;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;
      
      # Cookie preservation
      proxy_cookie_path / /;
      proxy_cookie_domain ~^(.*)$ $1;
    }
  }
}
